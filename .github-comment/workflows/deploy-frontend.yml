name: Deploy Frontend to S3

on:
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
      - '.github/workflows/deploy-frontend.yml'
  workflow_dispatch:  # Permite ejecutar manualmente desde GitHub

env:
  AWS_REGION: sa-east-1
  S3_BUCKET: blindpower-frontend-1763822834
  CLOUDFRONT_DISTRIBUTION_ID: E2ULKAFW4WIS12

jobs:
  deploy:
    name: Deploy Frontend to S3
    runs-on: ubuntu-latest

    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: Configurar credenciales AWS
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Actualizar URL del backend en app.js
      run: |
        # Reemplazar localhost con la URL de App Runner
        # Nota: Configura BACKEND_URL como secret en GitHub
        if [ -n "${{ secrets.BACKEND_URL }}" ]; then
          sed -i "s|http://localhost:8000|${{ secrets.BACKEND_URL }}|g" frontend/app.js
          echo "âœ“ Backend URL actualizada a: ${{ secrets.BACKEND_URL }}"
        else
          echo "âš ï¸  BACKEND_URL no estÃ¡ configurada. Usando localhost."
        fi

    - name: Deshabilitar Block Public Access
      run: |
        aws s3api put-public-access-block \
          --bucket $S3_BUCKET \
          --region $AWS_REGION \
          --public-access-block-configuration "BlockPublicAcls=false,IgnorePublicAcls=false,BlockPublicPolicy=false,RestrictPublicBuckets=false"

    - name: Sync a S3
      run: |
        aws s3 sync frontend/ s3://$S3_BUCKET/ \
          --region $AWS_REGION \
          --delete \
          --cache-control "public, max-age=3600" \
          --metadata-directive REPLACE

    - name: Invalidar cachÃ© de CloudFront
      run: |
        aws cloudfront create-invalidation \
          --distribution-id $CLOUDFRONT_DISTRIBUTION_ID \
          --paths "/*"
        echo "âœ“ CachÃ© de CloudFront invalidado"

    - name: Resumen del deployment
      run: |
        S3_URL="http://$S3_BUCKET.s3-website-$AWS_REGION.amazonaws.com"
        CLOUDFRONT_URL="https://d3hb5x9ur5btik.cloudfront.net"
        echo "### ðŸŽ¨ Frontend Deployed!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**S3 Bucket:** $S3_BUCKET" >> $GITHUB_STEP_SUMMARY
        echo "**S3 URL (HTTP):** $S3_URL" >> $GITHUB_STEP_SUMMARY
        echo "**CloudFront URL (HTTPS):** $CLOUDFRONT_URL â­" >> $GITHUB_STEP_SUMMARY
        echo "**RegiÃ³n:** $AWS_REGION" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— [Abrir sitio web (HTTPS)]($CLOUDFRONT_URL)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âš ï¸ **Importante:** Usa la URL de CloudFront (HTTPS) para que funcione el acceso a la cÃ¡mara." >> $GITHUB_STEP_SUMMARY
